<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Step-by-Step &mdash; Intel® Neural Compressor  documentation</title>
      <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../../index.html" class="icon icon-home"> Intel® Neural Compressor
          </a>
              <div class="version">
                1.14.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../README.html">Intel® Neural Compressor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/examples_readme.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../api-documentation/apis.html">APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/doclist.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/releases_info.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/contributions.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/legal_information.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/neural-compressor">Intel® Neural Compressor repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Intel® Neural Compressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Step-by-Step</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/examples/tensorflow/nlp/distilbert_base/quantization/ptq/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="step-by-step">
<h1>Step-by-Step<a class="headerlink" href="#step-by-step" title="Permalink to this heading"></a></h1>
<p>This document is used to list steps of reproducing TensorFlow Intel® Neural Compressor tuning zoo result of DistilBERT base. This example can be run on Intel CPUs and GPUs.</p>
<section id="model-details">
<h2>Model Details<a class="headerlink" href="#model-details" title="Permalink to this heading"></a></h2>
<p>This DistilBERT base model is based on the paper <a class="reference external" href="https://arxiv.org/abs/1910.01108"><em>DistilBERT, a distilled version of BERT: smaller, faster, cheaper and lighter</em></a>. <br />The <a class="reference external" href="https://huggingface.co/distilbert-base-uncased-finetuned-sst-2-english?text=I+like+you.+I+love+you">pretrained-model</a> thus used, was taken from <a class="reference external" href="https://huggingface.co/models">Hugging face model repository</a>. <br />The frozen model pb can be found at <a class="reference external" href="https://github.com/IntelAI/models/tree/master/models/language_modeling/tensorflow/distilbert_base/inference">Model Zoo for Intel® Architecture</a>.</p>
</section>
<section id="dataset-details">
<h2>Dataset Details<a class="headerlink" href="#dataset-details" title="Permalink to this heading"></a></h2>
<p>We use a part of Stanford Sentiment Treebank corpus for our task. Specifically, the validation split present in the SST2 dataset in the hugging face <a class="reference external" href="https://huggingface.co/datasets/sst2">repository</a>. It contains 872 labeled English sentences. The details for downloading the dataset are given below.</p>
</section>
<section id="prerequisite">
<h2>Prerequisite<a class="headerlink" href="#prerequisite" title="Permalink to this heading"></a></h2>
<section id="install-intel-neural-compressor">
<h3>1. Install Intel® Neural Compressor<a class="headerlink" href="#install-intel-neural-compressor" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install neural-compressor
</pre></div>
</div>
</section>
<section id="install-tensorflow-2-11-dev202242">
<h3>2. Install TensorFlow 2.11.dev202242<a class="headerlink" href="#install-tensorflow-2-11-dev202242" title="Permalink to this heading"></a></h3>
<p>Build a TensorFlow pip package from <a class="reference external" href="https://github.com/Intel-tensorflow/tensorflow/tree/spr_ww42">intel-tensorflow spr_ww42 branch</a> and install it. How to build a TensorFlow pip package from source please refer to this <a class="reference external" href="https://www.tensorflow.org/install/source">tutorial</a>.</p>
</section>
<section id="install-requirements">
<h3>3. Install Requirements<a class="headerlink" href="#install-requirements" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install -r requirements.txt
</pre></div>
</div>
</section>
<section id="install-intel-extension-for-tensorflow">
<h3>4. Install Intel® Extension for TensorFlow<a class="headerlink" href="#install-intel-extension-for-tensorflow" title="Permalink to this heading"></a></h3>
<section id="quantizing-the-model-on-intel-gpu">
<h4>Quantizing the model on Intel GPU:<a class="headerlink" href="#quantizing-the-model-on-intel-gpu" title="Permalink to this heading"></a></h4>
<p>Intel® Extension for TensorFlow is mandatory to be installed for quantizing the model on Intel GPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --upgrade intel-extension-for-tensorflow<span class="o">[</span>gpu<span class="o">]</span>
</pre></div>
</div>
<p>For any more details, please follow the procedure in <a class="reference external" href="https://github.com/intel/intel-extension-for-tensorflow/blob/main/docs/install/install_for_gpu.md#install-gpu-drivers">install-gpu-drivers</a>.</p>
</section>
<section id="quantizing-the-model-on-intel-cpu-experimental">
<h4>Quantizing the model on Intel CPU (Experimental):<a class="headerlink" href="#quantizing-the-model-on-intel-cpu-experimental" title="Permalink to this heading"></a></h4>
<p>Intel® Extension for TensorFlow for Intel CPUs is experimental currently. It’s not mandatory for quantizing the model on Intel CPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --upgrade intel-extension-for-tensorflow<span class="o">[</span>cpu<span class="o">]</span>
</pre></div>
</div>
</section>
</section>
<section id="download-dataset">
<h3>5. Download Dataset<a class="headerlink" href="#download-dataset" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python download_dataset.py --path_to_save_dataset &lt;enter path to save dataset&gt;
</pre></div>
</div>
</section>
</section>
<section id="run-command">
<h2>Run Command<a class="headerlink" href="#run-command" title="Permalink to this heading"></a></h2>
<section id="run-tuning">
<h3>Run Tuning:<a class="headerlink" href="#run-tuning" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>bash run_tuning.sh <span class="se">\</span>
    --input_model<span class="o">=</span><span class="nv">$INPUT_MODEL</span> <span class="se">\</span>
    --dataset_location<span class="o">=</span><span class="nv">$DATASET_DIR</span> <span class="se">\</span>
    --output_model<span class="o">=</span><span class="nv">$OUTPUT_MODEL</span> <span class="se">\</span>
    --config<span class="o">=</span><span class="nv">$CONFIG_FILE</span> <span class="se">\</span>
    --batch_size<span class="o">=</span><span class="nv">$BATCH_SIZE</span> <span class="se">\</span>
    --max_seq_length<span class="o">=</span><span class="nv">$MAX_SEQ</span> <span class="se">\</span>
    --warmup_steps<span class="o">=</span><span class="nv">$WARMUPS</span> <span class="se">\</span>
    --num_inter<span class="o">=</span><span class="nv">$INTER_THREADS</span> <span class="se">\</span>
    --num_intra<span class="o">=</span><span class="nv">$INTRA_THREADS</span>
</pre></div>
</div>
</section>
<section id="run-benchmark">
<h3>Run Benchmark:<a class="headerlink" href="#run-benchmark" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># benchmark mode: only get performance</span>
bash run_benchmark.sh <span class="se">\</span>
    --input_model<span class="o">=</span><span class="nv">$INPUT_MODEL</span> <span class="se">\</span>
    --dataset_location<span class="o">=</span><span class="nv">$DATASET_DIR</span> <span class="se">\</span>
    --mode<span class="o">=</span>benchmark <span class="se">\</span>
    --batch_size<span class="o">=</span><span class="nv">$BATCH_SIZE</span> <span class="se">\</span>
    --max_seq_length<span class="o">=</span><span class="nv">$MAX_SEQ</span> <span class="se">\</span>
    --iters<span class="o">=</span><span class="nv">$ITERS</span> <span class="se">\</span>
    --warmup_steps<span class="o">=</span><span class="nv">$WARMUPS</span> <span class="se">\</span>
    --num_inter<span class="o">=</span><span class="nv">$INTER_THREADS</span> <span class="se">\</span>
    --num_intra<span class="o">=</span><span class="nv">$INTRA_THREADS</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># accuracy mode: get performance and accuracy</span>
bash run_benchmark.sh <span class="se">\</span>
    --input_model<span class="o">=</span><span class="nv">$INPUT_MODEL</span> <span class="se">\</span>
    --dataset_location<span class="o">=</span><span class="nv">$DATASET_DIR</span> <span class="se">\</span>
    --mode<span class="o">=</span>accuracy <span class="se">\</span>
    --batch_size<span class="o">=</span><span class="nv">$BATCH_SIZE</span> <span class="se">\</span>
    --max_seq_length<span class="o">=</span><span class="nv">$MAX_SEQ</span> <span class="se">\</span>
    --warmup_steps<span class="o">=</span><span class="nv">$WARMUPS</span> <span class="se">\</span>
    --num_inter<span class="o">=</span><span class="nv">$INTER_THREADS</span> <span class="se">\</span>
    --num_intra<span class="o">=</span><span class="nv">$INTRA_THREADS</span>
</pre></div>
</div>
<p>Where (Default values are shown in the square brackets):</p>
<ul class="simple">
<li><p>$INPUT_MODEL [”./distilbert_base_fp32.pb”]– The path to input FP32 frozen model .pb file to load</p></li>
<li><p>$DATASET_DIR [”./sst2_validation_dataset”]– The path to input dataset directory</p></li>
<li><p>$OUTPUT_MODEL [”./output_distilbert_base_int8.pb”]– The user-specified export path to the output INT8 quantized model</p></li>
<li><p>$CONFIG_FILE [”./distilbert_base.yaml”]– The path to quantization configuration .yaml file to load for tuning</p></li>
<li><p>$BATCH_SIZE [128]– The batch size for model inference</p></li>
<li><p>$MAX_SEQ [128]– The maximum total sequence length after tokenization</p></li>
<li><p>$ITERS [872]– The number of iterations to run in benchmark mode, maximum value is 872</p></li>
<li><p>$WARMUPS [10]– The number of warmup steps before benchmarking the model, maximum value is 22</p></li>
<li><p>$INTER_THREADS [2]– The number of inter op parallelism thread to use, which can be set to the number of sockets</p></li>
<li><p>$INTRA_THREADS [28]– The number of intra op parallelism thread to use, which can be set to the number of physical core per socket</p></li>
</ul>
</section>
</section>
</section>
<section id="details-of-enabling-intel-neural-compressor-on-distilbert-base-for-tensorflow">
<h1>Details of enabling Intel® Neural Compressor on DistilBERT base for TensorFlow<a class="headerlink" href="#details-of-enabling-intel-neural-compressor-on-distilbert-base-for-tensorflow" title="Permalink to this heading"></a></h1>
<p>This is a tutorial of how to enable DistilBERT base model with Intel® Neural Compressor.</p>
<section id="user-code-analysis">
<h2>User Code Analysis<a class="headerlink" href="#user-code-analysis" title="Permalink to this heading"></a></h2>
<ol class="simple">
<li><p>User specifies fp32 <em>model</em>, calibration dataloader <em>q_dataloader</em>, evaluation dataloader <em>eval_dataloader</em> and metric in tuning.metric field of model-specific yaml config file.</p></li>
<li><p>User specifies fp32 <em>model</em>, calibration dataloader <em>q_dataloader</em> and a custom <em>eval_func</em> which encapsulates the evaluation dataloader and metric by itself.</p></li>
</ol>
<p>For DistilBERT base, we applied the latter one. The task is to implement the <em>q_dataloader</em> and <em>eval_func</em>.</p>
<section id="q-dataloader-part-adaption">
<h3>q_dataloader Part Adaption<a class="headerlink" href="#q-dataloader-part-adaption" title="Permalink to this heading"></a></h3>
<p>Below dataloader class uses generator function to provide the model with input.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dataloader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_location</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_location</span> <span class="o">=</span> <span class="n">data_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_batch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">steps</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_location</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_batch</span>

    <span class="k">def</span> <span class="nf">generate_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_location</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">data_location</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_batch</span><span class="p">):</span>
            <span class="n">feed_dict</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">create_feed_dict_and_labels</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</section>
<section id="write-yaml-config-file">
<h3>Write Yaml Config File<a class="headerlink" href="#write-yaml-config-file" title="Permalink to this heading"></a></h3>
<p>In examples directory, there is a distilbert_base.yaml for tuning the model on Intel CPUs. The ‘framework’ in the yaml is set to ‘tensorflow’. If running this example on Intel GPUs, the ‘framework’ should be set to ‘tensorflow_itex’ and the device in yaml file should be set to ‘gpu’. The distilbert_base_itex.yaml is prepared for the GPU case. We could remove most of items and only keep mandatory item for tuning. We also implement a calibration dataloader and have evaluation field for creation of evaluation function at internal neural_compressor.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">distilbert_base</span><span class="w"></span>
<span class="w">  </span><span class="nt">framework</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tensorflow</span><span class="w"></span>

<span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="w">                </span><span class="c1"># optional. default value is cpu, other value is gpu.</span><span class="w"></span>

<span class="nt">quantization</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">calibration</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">sampling_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span><span class="w"></span>
<span class="w">  </span><span class="nt">model_wise</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">weight</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">granularity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">per_channel</span><span class="w"></span>

<span class="nt">tuning</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">accuracy_criterion</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">relative</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.02</span><span class="w"></span>
<span class="w">  </span><span class="nt">exit_policy</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>
<span class="w">    </span><span class="nt">max_trials</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">    </span><span class="nt">performance_only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>
<span class="w">  </span><span class="nt">random_seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9527</span><span class="w"></span>
</pre></div>
</div>
<p>In this case we calibrate and quantize the model, and use our user-defined calibration dataloader.</p>
</section>
<section id="code-update">
<h3>Code Update<a class="headerlink" href="#code-update" title="Permalink to this heading"></a></h3>
<p>After prepare step is done, we add the code for quantization tuning to generate quantized model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neural_compressor.experimental</span> <span class="kn">import</span> <span class="n">Quantization</span><span class="p">,</span> <span class="n">common</span>
<span class="n">quantizer</span> <span class="o">=</span> <span class="n">Quantization</span><span class="p">(</span><span class="n">ARGS</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">calib_dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">eval_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_func</span> 
<span class="n">q_model</span> <span class="o">=</span> <span class="n">quantizer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>The Intel® Neural Compressor quantizer.fit() function will return a best quantized model under time constraint.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Intel® Neural Compressor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>