<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Graph Fusion and Optimization &mdash; Intel® Neural Compressor  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Intel® Neural Compressor
          </a>
              <div class="version">
                1.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Introduction to Intel® Neural Compressor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples_readme.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api-introduction.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/doclist.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases_info.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributions.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../legal_information.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security_policy.html">Security Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/neural-compressor">Intel® Neural Compressor repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Intel® Neural Compressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Graph Fusion and Optimization</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/engine/docs/graph_fusion.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="graph-fusion-and-optimization">
<h1>Graph Fusion and Optimization<a class="headerlink" href="#graph-fusion-and-optimization" title="Permalink to this headline">¶</a></h1>
<p>The main purpose of graph fusion and optimization is to simplify network and speed up inference. We take this process as a way of pattern mapping.  User could call the <code class="docutils literal notranslate"><span class="pre">pattern_mapping</span></code> API in <a class="reference external" href="https://github.com/intel/neural-compressor/blob/master/engine/compile/graph_utils.py"><code class="docutils literal notranslate"><span class="pre">engine.compile.graph_utils</span></code></a> to realize it. The process contains three steps: <strong>1. obtain the necessary information for new pattern construction; 2. create nodes and establish connections; 3. remove old pattern and insert new pattern.</strong>  Before implementing graph fusion and optimization, user should supply a config (dict) to instruct pattern mapping.</p>
<div class="section" id="pattern-mapping-dict">
<h2>Pattern mapping dict<a class="headerlink" href="#pattern-mapping-dict" title="Permalink to this headline">¶</a></h2>
<p>Here is a example of pattern mapping dict (a LayerNorm pattern in doc <a class="reference external" href="https://github.com/intel/neural-compressor/tree/master/engine/docs/add_customized_pattern.md">add_customized_pattern</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>    <span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">[[(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ReduceMean&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Sub&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Pow&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ReduceMean&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Add&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Sqrt&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Div&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;Mul&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;Add&#39;</span><span class="p">)]],</span>
                 <span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="p">[[(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;LayerNorm&#39;</span><span class="p">)]]</span>
                 <span class="p">},</span>
     <span class="s1">&#39;search_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;op_type&#39;</span><span class="p">,</span>
     <span class="s1">&#39;node_names&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="mi">0</span><span class="p">:</span> <span class="mi">8</span>
                   <span class="p">},</span>
     <span class="s1">&#39;input_tensors&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="mi">0</span><span class="p">:</span> <span class="p">[[{</span>
                            <span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="mi">7</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="mi">8</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">}],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">]]</span>
                       <span class="p">},</span>
     <span class="s1">&#39;output_tensors&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="mi">0</span><span class="p">:</span> <span class="p">[[{</span>
                            <span class="mi">8</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">}],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]]</span>
                    <span class="p">},</span>
     <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
     <span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">patterns</span></code> : gives the patterns representations before (<code class="docutils literal notranslate"><span class="pre">in</span></code>) and after (<code class="docutils literal notranslate"><span class="pre">out</span></code>) mapping. It is a dict with two keys (<code class="docutils literal notranslate"><span class="pre">in</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code>), and the values are the corresponding pattern representations. About the representation, refer to <a class="reference external" href="https://github.com/intel/neural-compressor/tree/master/engine/docs/pattern_recognition.md">pattern_recognition</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">search_mode</span></code>:  a string must be <code class="docutils literal notranslate"><span class="pre">op_type</span></code> or <code class="docutils literal notranslate"><span class="pre">node_name</span></code>. If set as <code class="docutils literal notranslate"><span class="pre">op_type</span></code>, the algorithm will search the old pattern (<code class="docutils literal notranslate"><span class="pre">in</span></code>) in graph. If set as  <code class="docutils literal notranslate"><span class="pre">node_name</span></code>, just means the old pattern (<code class="docutils literal notranslate"><span class="pre">in</span></code>) is  representing the search result. In most conditions, it should be <code class="docutils literal notranslate"><span class="pre">op_type</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node_names</span></code>:  a dict for setting node name for each node in new pattern. The key is the node index of new pattern (<code class="docutils literal notranslate"><span class="pre">out</span></code>).  The value must be string or integer. If string, just use it as the node’s name. If integer, use the name of index-th (<code class="docutils literal notranslate"><span class="pre">integer</span></code>) node in the old pattern(<code class="docutils literal notranslate"><span class="pre">in</span></code>).  Usually, the old pattern has many match_results in the graph, the algorithm would add “_n” after the name when the value is string. For example, the new node <code class="docutils literal notranslate"><span class="pre">0</span></code> (<code class="docutils literal notranslate"><span class="pre">0:</span> <span class="pre">embeddings_reshape</span> </code>) name should be <code class="docutils literal notranslate"><span class="pre">embeddings/reshape_0</span></code> of the first match_result.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input_tensors</span></code>: a dict for telling where to get the input tensors of new pattern (<code class="docutils literal notranslate"><span class="pre">out</span></code>).  These input tensors of patterns before or after fusion should be same.  The input tensors we said here are aimed at pattern. For example, the pattern can be thought as a big node and it receives and emits tensors which should be equal before or after fusion. So the <code class="docutils literal notranslate"><span class="pre">input_tensors</span></code> supplies information of the input tensor outside rather than the tensors inside pattern.  The key is the node index of new pattern (<code class="docutils literal notranslate"><span class="pre">out</span></code>). The first list in the value list means where are the outside input tensors from (which input tensors index of which node in old pattern). And the second list means which locations these tensors would be put (which input tensor index of node in new pattern and number of them ) . For example, the above <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">:[</span> <span class="pre">[{0:</span> <span class="pre">[0]},</span> <span class="pre">{7:</span> <span class="pre">[1]},</span> <span class="pre">{8:[1]}],</span> <span class="pre">[[0,</span> <span class="pre">1,</span> <span class="pre">2],</span> <span class="pre">3]</span> <span class="pre">]</span></code> shows that the 0-th node in new pattern needs three outside input tensors. The first one is 0-th input tensor of 0-th node in old pattern, the second one is 1-st input tensor of 7-th node in old pattern, and the third one is 1-st input tensor of 8-th node in old pattern. <code class="docutils literal notranslate"><span class="pre">[[0,</span> <span class="pre">1,</span> <span class="pre">2],</span> <span class="pre">3]</span></code> means these three tensors are as 0-th, 1-st, 2-nd input tensor respectively of 0-th node in new pattern (just copy tensors) and this node has three input tensors totally. Sometimes the tensor number is greater than the length of first list for the reason that this node would receive tensor from its last node in new pattern, like <code class="docutils literal notranslate"><span class="pre">[[0,</span> <span class="pre">1],</span> <span class="pre">3]</span></code>. This 2-nd tensor will be generated and sent automatically inside new sequence pattern.</p>
<blockquote>
<div><p>NOTE:</p>
<ul class="simple">
<li><p>In some models, the tensor index in <code class="docutils literal notranslate"><span class="pre">input_tensors</span></code> could be different in a pattern. For example, pattern <code class="docutils literal notranslate"><span class="pre">[[(0,</span> <span class="pre">'MatMul'),</span> <span class="pre">(1,</span> <span class="pre">'BiasAdd'),</span> <span class="pre">(2,</span> <span class="pre">'Add')]]</span></code> , the <code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">'Add')</span></code> node have 2 input tensors, the one is from <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">'BiasAdd')</span></code>, the another one is from other node, which is need to be written into <code class="docutils literal notranslate"><span class="pre">input_tensors</span></code>. However, this tensor index might be 0 in part of matched results while 1 in other results.  You can use <code class="docutils literal notranslate"><span class="pre">{2:</span> <span class="pre">[0,</span> <span class="pre">1]}</span></code> to point this phenomenon and the algorithm would check the tensor name and get the correct one.</p></li>
<li><p>If some input_tensors only can get from other node outside the pattern, you can just specify it by give the node name in graph, like <code class="docutils literal notranslate"><span class="pre">0:</span> <span class="pre">[[{'reshape_0':</span> <span class="pre">[0]}],</span> <span class="pre">[[0],</span> <span class="pre">1]]</span></code>.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_tensors</span></code>: a dict for telling where to get the output tensors of new pattern (<code class="docutils literal notranslate"><span class="pre">out</span></code>). Its representations are similar to <code class="docutils literal notranslate"><span class="pre">input_tensors</span></code>. In most situations, the last nod of new pattern should has the same output tensors as the last node of old pattern (sequence pattern for now and all nodes have one output tensor). So, usually users just need set the last node output tensors and leave the rest nodes output tensors empty while keeping the number of tensors (the algorithm would generate internally).  For example, a new pattern is <code class="docutils literal notranslate"><span class="pre">[[(0,</span> <span class="pre">'op_type'),</span> <span class="pre">(1,</span> <span class="pre">'op_type'),</span> <span class="pre">(2,</span> <span class="pre">'op_type')]]</span></code>, then its <code class="docutils literal notranslate"><span class="pre">output_tensors</span></code> could be like <code class="docutils literal notranslate"><span class="pre">{0:</span> <span class="pre">[[],</span> <span class="pre">[[],</span> <span class="pre">1]],</span> <span class="pre">1:</span> <span class="pre">[[],</span> <span class="pre">[[],</span> <span class="pre">1]],</span> <span class="pre">2:</span> <span class="pre">[[{old_node_index:</span> <span class="pre">[0]}],</span> <span class="pre">[[0],</span> <span class="pre">1]]}</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">returns</span></code>: a list contains some nodes indexes of old pattern (<code class="docutils literal notranslate"><span class="pre">in</span></code>). It would return these old nodes when pattern mapping finish.  Sometimes user requires specific nodes for setting node attributes in new pattern. You can set the value as <code class="docutils literal notranslate"><span class="pre">[]</span></code> if no need.</p></li>
</ul>
</div>
<div class="section" id="obtain-the-necessary-information-for-new-pattern-construction">
<h2>Obtain the necessary information for new pattern construction<a class="headerlink" href="#obtain-the-necessary-information-for-new-pattern-construction" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pattern_mapping</span></code> API first search the <code class="docutils literal notranslate"><span class="pre">in</span></code> pattern and get the matched result. Then prepare node names, input tensors, output tensors these necessary information for <code class="docutils literal notranslate"><span class="pre">out</span></code> pattern by following the above pattern mapping dict. It also store some specific nodes in old pattern if needed.  These related variables have the same length as matched result of <code class="docutils literal notranslate"><span class="pre">in</span></code> pattern. For more details, please see the <code class="docutils literal notranslate"><span class="pre">_get_pattern_info</span></code> function in <a class="reference external" href="https://github.com/intel/neural-compressor/blob/master/engine/compile/graph_utils.py"><code class="docutils literal notranslate"><span class="pre">engine.compile.graph_utils</span></code></a>.</p>
</div>
<div class="section" id="create-nodes-and-establish-connections">
<h2>Create nodes and establish connections<a class="headerlink" href="#create-nodes-and-establish-connections" title="Permalink to this headline">¶</a></h2>
<p>In this step, <code class="docutils literal notranslate"><span class="pre">pattern_mapping</span></code> API receives the above node names, input tensors and output tensors information to create new nodes in <code class="docutils literal notranslate"><span class="pre">out</span></code> pattern. The main part is to establish nodes connections by filling and constructing tensors. The connections outside are maintained with keeping the tensors in or out patterns same. As for the connections inside new pattern, output tensor of pre-node would be generated automatically and become one input tensor of next node due to sequential flow. For more details, please see the <code class="docutils literal notranslate"><span class="pre">_create_out_pattern</span></code> function in <a class="reference external" href="https://github.com/intel/neural-compressor/blob/master/engine/compile/graph_utils.py"><code class="docutils literal notranslate"><span class="pre">engine.compile.graph_utils</span></code></a>.</p>
</div>
<div class="section" id="remove-old-pattern-and-insert-new-pattern">
<h2>Remove old pattern and insert new pattern<a class="headerlink" href="#remove-old-pattern-and-insert-new-pattern" title="Permalink to this headline">¶</a></h2>
<p>After creating new pattern, the final step is to replace the old pattern with new pattern. For more details, please see the <code class="docutils literal notranslate"><span class="pre">_replace_pattern</span></code> function in <a class="reference external" href="https://github.com/intel/neural-compressor/blob/master/engine/compile/graph_utils.py"><code class="docutils literal notranslate"><span class="pre">engine.compile.graph_utils</span></code></a>.</p>
<p>Do not forget to set specific attributes of your new pattern if it has. These attributes could influence the inference of engine. And the <code class="docutils literal notranslate"><span class="pre">returns</span></code> supply the way to obtain them from the nodes in old pattern. Please see the <a class="reference external" href="https://github.com/intel/neural-compressor/tree/master/engine/docs/add_customized_pattern.md">add_customized_pattern</a> doc for adding your own example.</p>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Intel® Neural Compressor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>