<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add a customized operator and register to engine executor &mdash; Intel® Neural Compressor  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Intel® Neural Compressor
          </a>
              <div class="version">
                1.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Introduction to Intel® Neural Compressor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples_readme.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api-introduction.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/doclist.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases_info.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributions.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../legal_information.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security_policy.html">Security Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/neural-compressor">Intel® Neural Compressor repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Intel® Neural Compressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Add a customized operator and register to engine executor</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/engine/docs/operator_register.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="add-a-customized-operator-and-register-to-engine-executor">
<h1>Add a customized operator and register to engine executor<a class="headerlink" href="#add-a-customized-operator-and-register-to-engine-executor" title="Permalink to this headline">¶</a></h1>
<p>It’s very easy to add a customized operator and register to engine executor. Three steps are only needed to register a customized operator: 1. Add *.h of customized operator to executor/include/operators; 2. Add *.cpp of customized operator to executor/src/operators; 3. Add path of *.cpp to CMakeLists.txt for compiling. Let’s register Gelu operator to engine executor as an example.</p>
<div class="section" id="add-h-of-customized-operator-to-executor-include-operators">
<h2>1. Add *.h of customized operator to executor/include/operators<a class="headerlink" href="#add-h-of-customized-operator-to-executor-include-operators" title="Permalink to this headline">¶</a></h2>
<p>The *.h is the file to define member variables and functions. Class GeluOperator inherits from class Operator. GeluOperator has basic constructor, destructor, Reshape function and Forward function. And it also has some member variables used inside the class. The examples use oneDNN API, so we define some variables for onednn primitives. The details about oneDNN can refer the following link https://oneapi-src.github.io/oneDNN/index.html.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GeluOperator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Operator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">GeluOperator</span><span class="p">(</span><span class="k">const</span> <span class="n">OperatorConfig</span><span class="o">&amp;</span> <span class="n">conf</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">GeluOperator</span><span class="p">()</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">Reshape</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">input</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">output</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">Forward</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">input</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">output</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">string</span> <span class="n">algorithm_</span><span class="p">;</span>
  <span class="n">dnnl</span><span class="o">::</span><span class="n">engine</span> <span class="n">eng_</span> <span class="o">=</span> <span class="n">engine</span><span class="p">(</span><span class="n">engine</span><span class="o">::</span><span class="n">kind</span><span class="o">::</span><span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dnnl</span><span class="o">::</span><span class="n">eltwise_forward</span> <span class="n">gelu_p_</span><span class="p">;</span>
  <span class="n">memory</span> <span class="n">src_m_</span><span class="p">;</span>
  <span class="n">memory</span> <span class="n">dst_m_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="add-cpp-of-customized-operator-to-executor-src-operators">
<h2>2. Add *.cpp of customized operator to executor/src/operators<a class="headerlink" href="#add-cpp-of-customized-operator-to-executor-src-operators" title="Permalink to this headline">¶</a></h2>
<p>It’s the constructor used to parse the parameters like attributes in the operator. Gelu has two algorithm gelu_erf and gelu_tanh, so the attribute “algorithm” is parsed here.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">GeluOperator</span><span class="o">::</span><span class="n">GeluOperator</span><span class="p">(</span><span class="k">const</span> <span class="n">OperatorConfig</span><span class="o">&amp;</span> <span class="n">conf</span><span class="p">)</span> <span class="o">:</span>
  <span class="n">Operator</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">attrs_map</span> <span class="o">=</span> <span class="n">operator_conf_</span><span class="p">.</span><span class="n">attributes</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">attrs_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;algorithm&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">attrs_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">algorithm_</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Output shape maybe is dynamic, so you can adjust the shape of output tensor in reshape function. And the gelu operator is based on oneDNN, so we also prepare primitive here.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">GeluOperator</span><span class="o">::</span><span class="n">Reshape</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">input</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//// Part1: Prepare tensors shape and memory descriptors</span>
  <span class="c1">// 1.1: Prepare src tensor shape</span>
  <span class="k">const</span> <span class="n">memory</span><span class="o">::</span><span class="n">dims</span><span class="o">&amp;</span> <span class="n">src_shape</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>

  <span class="c1">// 1.2 Set dst tensor shape</span>
  <span class="k">const</span> <span class="n">memory</span><span class="o">::</span><span class="n">dims</span><span class="o">&amp;</span> <span class="n">dst_shape</span> <span class="o">=</span> <span class="n">src_shape</span><span class="p">;</span>
  <span class="n">Tensor</span><span class="o">*</span> <span class="n">dst_tensor_ptr</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">dst_tensor_ptr</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">dst_shape</span><span class="p">);</span>

  <span class="c1">// 1.3 Get tensor&#39;s strides</span>
  <span class="n">memory</span><span class="o">::</span><span class="n">dims</span> <span class="n">src_stride</span> <span class="o">=</span> <span class="n">GetStrides</span><span class="p">(</span><span class="n">src_shape</span><span class="p">);</span>
  <span class="n">memory</span><span class="o">::</span><span class="n">dims</span> <span class="n">dst_stride</span> <span class="o">=</span> <span class="n">GetStrides</span><span class="p">(</span><span class="n">dst_shape</span><span class="p">);</span>

  <span class="c1">// 1.4 Prepare memory descriptors</span>
  <span class="n">memory</span><span class="o">::</span><span class="n">desc</span> <span class="n">src_md</span><span class="p">(</span><span class="n">src_shape</span><span class="p">,</span> <span class="n">memory</span><span class="o">::</span><span class="n">data_type</span><span class="o">::</span><span class="n">f32</span><span class="p">,</span> <span class="n">src_stride</span><span class="p">);</span>
  <span class="n">memory</span><span class="o">::</span><span class="n">desc</span> <span class="n">dst_md</span><span class="p">(</span><span class="n">dst_shape</span><span class="p">,</span> <span class="n">memory</span><span class="o">::</span><span class="n">data_type</span><span class="o">::</span><span class="n">f32</span><span class="p">,</span> <span class="n">dst_stride</span><span class="p">);</span>
  
  <span class="c1">// 1.5 Prepare memory objects (cached)</span>
  <span class="n">src_m_</span> <span class="o">=</span> <span class="n">memory</span><span class="p">(</span><span class="n">src_md</span><span class="p">,</span> <span class="n">eng_</span><span class="p">);</span>
  <span class="n">dst_m_</span> <span class="o">=</span> <span class="n">memory</span><span class="p">(</span><span class="n">dst_md</span><span class="p">,</span> <span class="n">eng_</span><span class="p">);</span>

  <span class="c1">//// Part2: Prepare primitive</span>
  <span class="c1">// 2.1 Prepare op descriptors</span>
  <span class="n">algorithm</span> <span class="n">gelu_algorithm</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">algorithm_</span> <span class="o">==</span> <span class="s">&quot;gelu_erf&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gelu_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">::</span><span class="n">eltwise_gelu_erf</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">algorithm_</span> <span class="o">==</span> <span class="s">&quot;gelu_tanh&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gelu_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">::</span><span class="n">eltwise_gelu_tanh</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Gelu algorithm is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">algorithm_</span>
               <span class="o">&lt;&lt;</span> <span class="s">&quot;, not supported. Only gelu_erf or gelu_tanh is supported.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="n">gelu_d</span> <span class="o">=</span> <span class="n">dnnl</span><span class="o">::</span><span class="n">eltwise_forward</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="n">prop_kind</span><span class="o">::</span><span class="n">forward_inference</span><span class="p">,</span>
                <span class="n">gelu_algorithm</span><span class="p">,</span> <span class="n">src_md</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>

  <span class="c1">// 2.2 Prepare primitive descriptors</span>
  <span class="n">dnnl</span><span class="o">::</span><span class="n">eltwise_forward</span><span class="o">::</span><span class="n">primitive_desc</span> <span class="n">gelu_pd</span><span class="p">(</span><span class="n">gelu_d</span><span class="p">,</span> <span class="n">eng_</span><span class="p">);</span>

  <span class="c1">// 2.3 Prepare primitive objects (cached)</span>
  <span class="n">gelu_p_</span> <span class="o">=</span> <span class="n">dnnl</span><span class="o">::</span><span class="n">eltwise_forward</span><span class="p">(</span><span class="n">gelu_pd</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Forward function is to execute operator. Using oneDNN, we set input and output to data_handle, and execute the primitive. And after executing the primitive, don’t forget to unref input tensors, that’s to reduce the reference count of tensor and manage memory more rigorously.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">GeluOperator</span><span class="o">::</span><span class="n">Forward</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">input</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">*&gt;&amp;</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// 1. Alias variables part</span>
<span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">src_data</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">();</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">dst_data</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mutable_data</span><span class="p">();</span>

<span class="c1">// 2. Prepare memory objects with data_ptr</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">stream</span> <span class="n">s</span><span class="p">(</span><span class="n">eng_</span><span class="p">);</span>
<span class="n">src_m_</span><span class="p">.</span><span class="n">set_data_handle</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">src_data</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
<span class="n">dst_m_</span><span class="p">.</span><span class="n">set_data_handle</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dst_data</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>

<span class="c1">// 3. Insert memory args</span>
<span class="n">memory_args_</span><span class="p">[</span><span class="n">DNNL_ARG_SRC</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_m_</span><span class="p">;</span>
<span class="n">memory_args_</span><span class="p">[</span><span class="n">DNNL_ARG_DST</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst_m_</span><span class="p">;</span>

<span class="c1">// 4. Execute the primitive</span>
<span class="n">gelu_p_</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">memory_args_</span><span class="p">);</span>

<span class="c1">// 5. unref tensors</span>
<span class="k">this</span><span class="o">-&gt;</span><span class="n">unref_tensors</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After creating the customized operator, finally register it to operator class as follow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">REGISTER_OPERATOR_CLASS</span><span class="p">(</span><span class="n">Gelu</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="add-cpp-to-cmakelists-txt">
<h2>3. add *.cpp to CMakeLists.txt<a class="headerlink" href="#add-cpp-to-cmakelists-txt" title="Permalink to this headline">¶</a></h2>
<p>Each operator is compiled as shared library, so we should add gelu.cpp to CMakeLists.txt.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add_library</span><span class="p">(</span><span class="n">engine</span> <span class="n">SHARED</span>
    <span class="n">src</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">cpp</span>
    <span class="n">src</span><span class="o">/</span><span class="n">operators</span><span class="o">/</span><span class="n">gelu</span><span class="o">.</span><span class="n">cpp</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Intel® Neural Compressor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>